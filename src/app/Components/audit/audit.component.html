<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="card shadow-sm mb-2">
        <div class="card-body py-1 px-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <h5 class="mb-0" style="color: #333;">Registros de Auditoría</h5>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje de error general -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show mb-2" role="alert">
        <div class="d-flex align-items-center">
          <i nz-icon nzType="exclamation-circle" class="me-2"></i>
          <span>{{ errorMessage }}</span>
        </div>
        <button type="button" class="btn-close" (click)="clearError()"></button>
      </div>

      <!-- Filtros -->
      <div class="card shadow-sm mb-2">
        <div class="card-body py-1 px-3">
          <div class="row g-1 align-items-center">
            <!-- Username -->
            <div class="col-md-3">
              <input 
                type="text" 
                class="form-control form-control-sm"
                [(ngModel)]="SearchUsername"
                placeholder="Usuario...">
            </div>
            
            <!-- Tipo de Acción -->
            <div class="col-md-2">
              <select class="form-select form-select-sm" [(ngModel)]="SelectedActionType">
                <option value="">Todas las acciones</option>
                <option *ngFor="let action of actionTypes" [value]="action">
                  {{ action }}
                </option>
              </select>
            </div>

            <!-- Tipo de Entidad -->
            <div class="col-md-2">
              <select class="form-select form-select-sm" [(ngModel)]="SelectedEntityType">
                <option value="">Todas las entidades</option>
                <option *ngFor="let entity of entityTypes" [value]="entity">
                  {{ entity }}
                </option>
              </select>
            </div>

            <!-- Fecha Inicio -->
            <div class="col-md-2">
              <input 
                type="date" 
                class="form-control form-control-sm"
                [(ngModel)]="StartDate"
                placeholder="Desde...">
            </div>

            <!-- Fecha Fin -->
            <div class="col-md-2">
              <input 
                type="date" 
                class="form-control form-control-sm"
                [(ngModel)]="EndDate"
                placeholder="Hasta...">
            </div>

            <!-- Botones -->
            <div class="col-md-1">
              <button class="btn btn-primary btn-sm me-1" (click)="ApplyFilters()">
                <i nz-icon nzType="search"></i>
              </button>
              <button class="btn btn-secondary btn-sm" (click)="ClearFilters()">
                <i nz-icon nzType="clear"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de auditorías -->
      <div class="card shadow-sm">
        <div class="card-header py-2 px-3">
          <h6 class="mb-0">Registros de Auditoría</h6>
        </div>
        <div class="card-body p-0">
          <nz-table #auditTable [nzData]="DataSourceAudit" class="w-100 compact-table" nzSize="small">
            <thead>
              <tr>
                <th class="ps-2" style="color: #333;">Fecha/Hora</th>
                <th style="color: #333;">Usuario</th>
                <th style="color: #333;">Acción</th>
                <th style="color: #333;">Entidad</th>
                <th style="color: #333;">ID Entidad</th>
                <th style="color: #333;">Estado</th>
                <th style="color: #333;">IP</th>
                <th class="text-center pe-2" style="color: #333;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of auditTable.data" class="table-row">
                <td class="ps-2" style="color: #333;">
                  <small>{{ log.created_at | date:'dd/MM/yyyy HH:mm' }}</small>
                </td>
                <td style="color: #333;">
                  <strong>{{ log.username || 'Sistema' }}</strong>
                  <br>
                  <small class="text-muted">ID: {{ log.user_id || 'N/A' }}</small>
                </td>
                <td style="color: #333;">
                  <span [class]="getActionTypeClass(log.action_type)">
                    {{ log.action_type }}
                  </span>
                </td>
                <td style="color: #333;">{{ log.entity_type || '-' }}</td>
                <td style="color: #333;">{{ log.entity_id || '-' }}</td>
                <td style="color: #333;">
                  <span [class]="getStatusClass(log.status)">
                    {{ log.status }}
                  </span>
                </td>
                <td style="color: #333;">
                  <small>{{ log.ip_address || '-' }}</small>
                </td>
                <td class="text-center pe-2">
                  <div class="d-flex gap-1 justify-content-center">
                    <!-- Botón para ver cambios -->
                    <button 
                      *ngIf="hasChanges(log.changes)"
                      class="btn btn-outline-info btn-sm"
                      (click)="viewChanges(log.changes)"
                      title="Ver cambios">
                      <i nz-icon nzType="edit"></i>
                    </button>
                    
                    <!-- Botón para ver error -->
                    <button 
                      *ngIf="hasError(log.error_message)"
                      class="btn btn-outline-danger btn-sm"
                      (click)="viewError(log.error_message)"
                      title="Ver error">
                      <i nz-icon nzType="exclamation-circle"></i>
                    </button>
                    
                    <!-- Placeholder cuando no hay acciones -->
                    <span *ngIf="!hasChanges(log.changes) && !hasError(log.error_message)" class="text-muted">-</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver cambios completos -->
  <div *ngIf="showChangesModal" class="modal-backdrop fade show" (click)="closeChangesModal()"></div>
  <div *ngIf="showChangesModal" class="modal fade show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i nz-icon nzType="file-text" class="me-2"></i>
            Detalles de Cambios
          </h5>
          <button type="button" class="btn-close" (click)="closeChangesModal()"></button>
        </div>
        <div class="modal-body p-0">
          <pre class="json-content">{{ changesJson }}</pre>
        </div>
        <div class="modal-footer">
          <div class="me-auto">
            <span *ngIf="copySuccess" class="text-success small">
              <i nz-icon nzType="check-circle" class="me-1"></i>
              ¡Copiado al portapapeles!
            </span>
          </div>
          <button type="button" class="btn btn-secondary" (click)="closeChangesModal()">
            Cerrar
          </button>
          <button type="button" class="btn btn-primary" (click)="copyToClipboard()">
            <i nz-icon nzType="copy" class="me-1"></i>
            Copiar JSON
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver errores -->
  <div *ngIf="showErrorModal" class="modal-backdrop fade show" (click)="closeErrorModal()"></div>
  <div *ngIf="showErrorModal" class="modal fade show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i nz-icon nzType="exclamation-circle" class="me-2"></i>
            Detalles del Error
          </h5>
          <button type="button" class="btn-close" (click)="closeErrorModal()"></button>
        </div>
        <div class="modal-body p-0">
          <pre class="error-content">{{ selectedError }}</pre>
        </div>
        <div class="modal-footer">
          <div class="me-auto">
            <span *ngIf="copySuccess" class="text-success small">
              <i nz-icon nzType="check-circle" class="me-1"></i>
              ¡Copiado al portapapeles!
            </span>
          </div>
          <button type="button" class="btn btn-secondary" (click)="closeErrorModal()">
            Cerrar
          </button>
          <button type="button" class="btn btn-primary" (click)="copyErrorToClipboard()">
            <i nz-icon nzType="copy" class="me-1"></i>
            Copiar Error
          </button>
        </div>
      </div>
    </div>
  </div>
</div>